<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Sampling" />
  <meta name="theme-color" content="#1a472a" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%231a472a' width='180' height='180'/><text x='50%' y='50%' font-size='80' fill='white' text-anchor='middle' dominant-baseline='middle' font-family='system-ui'>‚õè</text></svg>" />
  <title>Sampling - –£—á—ë—Ç –ø—Ä–æ–±</title>

  <style>
    :root{
      --green1:#1a472a;
      --green2:#2d6b42;
      --bg:#f5f5f5;
      --bg-dark:#1a1a1a;
      --card:#ffffff;
      --card-dark:#2a2a2a;
      --text:#333;
      --text-dark:#e0e0e0;
      --muted:#666;
      --muted-dark:#aaa;
      --border:#e0e0e0;
      --border-dark:#444;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    /* –ö–ª—é—á–µ–≤—ã–µ —Ñ–∏–∫—Å—ã –ø–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω:
       1) –£–±–∏—Ä–∞–µ–º overflow:hidden (–æ–Ω —Ä–µ–∑–∞–ª –Ω–∏–∑ –∏ –ª–æ–º–∞–ª –ø—Ä–æ–∫—Ä—É—Ç–∫—É).
       2) –ó–∞–ø—Ä–µ—â–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª.
       3) –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –µ–¥–∏–Ω–∏—Ü—ã (dvh) –∏ safe-area.
    */
    html, body {
      width: 100%;
      max-width: 100%;
      height: auto;
      min-height: 100dvh;
      overflow-x: hidden;
      overflow-y: auto;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    body.dark-mode {
      background: var(--bg-dark);
      color: var(--text-dark);
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å –Ω–µ "–Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ", –∞ —Ä–∞—Å—Ç—ë—Ç –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É */
    #app {
      width: 100%;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      padding-bottom: env(safe-area-inset-bottom);
    }

    /* HEADER */
    .header {
      background: linear-gradient(135deg, var(--green1) 0%, var(--green2) 100%);
      color: white;
      padding: 12px 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 50;
    }

    .header h1 {
      font-size: 18px;
      margin-bottom: 4px;
    }

    .sync-status {
      font-size: 12px;
      opacity: 0.95;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .sync-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ffeb3b;
      animation: pulse 1.5s infinite;
      flex: 0 0 auto;
    }

    .sync-indicator.ok { background: #4caf50; animation: none; }
    .sync-indicator.error { background: #f44336; animation: none; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* THEME TOGGLE */
    .theme-toggle {
      position: fixed;
      top: 64px;
      right: 12px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      z-index: 60;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    body.dark-mode .theme-toggle { background: var(--card-dark); border-color: var(--border-dark); }

    /* MAIN CONTENT */
    .main-container {
      width: 100%;
      display: flex;
      gap: 16px;
      padding: 12px;
      background: var(--bg);
      overflow-x: hidden;
      /* –í–∞–∂–Ω–æ: –Ω–∏–∫–∞–∫–∏—Ö —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤—ã—Å–æ—Ç -> –Ω–æ—Ä–º–∞–ª—å–Ω–æ —Å–∫—Ä–æ–ª–ª–∏—Ç—Å—è */
      flex: 1 1 auto;
      align-items: flex-start;
    }

    body.dark-mode .main-container { background: var(--bg-dark); }

    .left-panel {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-width: 0; /* –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª –∏–∑-–∑–∞ flex */
    }

    /* –î–µ—Å–∫—Ç–æ–ø–Ω–∞—è –ø—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å (—Å–ø–∏—Å–æ–∫) */
    .right-panel {
      width: 0;
      overflow: hidden;
      transition: width 0.25s ease;
      background: var(--card);
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      flex: 0 0 auto;
    }
    body.dark-mode .right-panel { background: var(--card-dark); }

    .right-panel.active {
      width: 320px;
      overflow: hidden;
    }

    /* –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å–ø–∏—Å–∫–∞ ‚Äî off-canvas (–Ω–µ —Ä–∞–∑–¥–≤–∏–≥–∞–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –∏ –Ω–µ –¥–∞—ë—Ç —Å–¥–≤–∏–≥ –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ) */
    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
        gap: 10px;
        padding: 10px;
      }

      .right-panel {
        position: fixed;
        top: 0;
        right: 0;
        height: 100dvh;
        width: min(360px, 88vw);
        transform: translateX(110%);
        transition: transform 0.25s ease;
        z-index: 120;
        border-radius: 0;
      }

      .right-panel.active {
        transform: translateX(0);
      }
    }

    /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω –∑–∞ –≤—ã–µ–∑–∂–∞—é—â–µ–π –ø–∞–Ω–µ–ª—å—é (–º–æ–±) */
    .drawer-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      z-index: 110;
    }
    .drawer-backdrop.active { display: block; }

    /* SECTIONS */
    .section {
      background: var(--card);
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      min-width: 0;
    }
    body.dark-mode .section { background: var(--card-dark); box-shadow: 0 2px 8px rgba(255,255,255,0.05); }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--green1);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    body.dark-mode .section-title { color: #7fb3a3; }

    /* VIDEO & CAMERA */
    #videoContainer {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
      background: #000;
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    @media (min-width: 769px) {
      #videoContainer { aspect-ratio: 4 / 3; }
    }

    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .camera-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 70%;
      height: 40%;
      border: 3px dashed rgba(255, 255, 255, 0.5);
      border-radius: 8px;
      pointer-events: none;
      box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.1);
    }

    .camera-overlay::before {
      content: '';
      position: absolute;
      inset: 0;
      border: 2px solid rgba(76, 175, 80, 0.3);
      border-radius: 8px;
      animation: scanLine 2s infinite;
    }

    @keyframes scanLine {
      0% { transform: translateY(-100%); }
      100% { transform: translateY(100%); }
    }

    .camera-status {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
      z-index: 10;
    }

    .camera-status.scanning { animation: pulse-status 1s infinite; }

    @keyframes pulse-status {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* FORM CONTROLS */
    .form-group { margin-bottom: 10px; display: flex; flex-direction: column; }
    .form-group.inline { flex-direction: row; gap: 8px; }
    .form-group.inline > input, .form-group.inline > select { flex: 1; min-width: 0; }

    label {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #555;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    body.dark-mode label { color: #aaa; }

    input, select, textarea {
      padding: 10px 8px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      background: white;
      color: var(--text);
      transition: border-color 0.2s, background 0.2s;
      min-width: 0;
    }
    body.dark-mode input, body.dark-mode select, body.dark-mode textarea {
      background: #333;
      color: var(--text-dark);
      border-color: var(--border-dark);
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--green1);
      box-shadow: 0 0 0 3px rgba(26, 71, 42, 0.1);
    }
    body.dark-mode input:focus, body.dark-mode select:focus, body.dark-mode textarea:focus {
      box-shadow: 0 0 0 3px rgba(127, 179, 163, 0.2);
    }

    input::placeholder { color: #999; }
    body.dark-mode input::placeholder { color: #666; }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

    /* BUTTONS */
    button {
      padding: 10px 14px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--green1) 0%, var(--green2) 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(26, 71, 42, 0.2);
    }
    .btn-primary:active { transform: translateY(1px); box-shadow: 0 2px 6px rgba(26, 71, 42, 0.2); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
      border: 1px solid #ddd;
    }
    body.dark-mode .btn-secondary { background: #333; color: #e0e0e0; border-color: var(--border-dark); }

    .btn-secondary:active { background: #e0e0e0; }
    body.dark-mode .btn-secondary:active { background: #3a3a3a; }

    /* STATUS MESSAGE */
    .status-message {
      padding: 10px;
      border-radius: 6px;
      font-size: 13px;
      text-align: center;
      font-weight: 500;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      background: #f9f9f9;
      border: 1px solid #e0e0e0;
      word-break: break-word;
    }
    body.dark-mode .status-message { background: #333; color: #aaa; border-color: var(--border-dark); }

    .status-message.success { background: #e8f5e9; color: #2e7d32; border-color: #81c784; }
    body.dark-mode .status-message.success { background: #1b3a1b; color: #81c784; border-color: #2e5f2e; }

    .status-message.error { background: #ffebee; color: #c62828; border-color: #ef5350; }
    body.dark-mode .status-message.error { background: #3a1b1b; color: #ef5350; border-color: #5f2e2e; }

    /* COUNTERS */
    .counters {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 12px;
    }
    @media (max-width: 600px) { .counters { grid-template-columns: 1fr; } }

    .counter {
      background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
      padding: 10px;
      border-radius: 6px;
      text-align: center;
      border: 1px solid #c8e6c9;
    }
    body.dark-mode .counter { background: linear-gradient(135deg, #1b3a1b 0%, #1d3a1d 100%); border-color: #2e5f2e; }

    .counter-label { color: #666; margin-bottom: 4px; font-weight: 500; }
    body.dark-mode .counter-label { color: #aaa; }

    .counter-value { font-size: 18px; font-weight: 700; color: #2e7d32; }
    body.dark-mode .counter-value { color: #81c784; }

    /* RIGHT PANEL - LIST */
    .list-header {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    body.dark-mode .list-header { border-bottom-color: var(--border-dark); }

    .search-box { margin-bottom: 8px; }
    .search-box input { width: 100%; }

    .checkbox-group { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
    .checkbox-group input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
    .checkbox-group label { margin: 0; font-size: 12px; cursor: pointer; flex: 1; text-transform: none; letter-spacing: 0; }

    .scans-list { flex: 1; overflow-y: auto; padding: 8px; }
    .scan-item {
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-bottom: 6px;
      background: #fafafa;
      font-size: 12px;
      transition: background 0.2s;
      word-break: break-word;
    }
    body.dark-mode .scan-item { background: #333; border-color: var(--border-dark); }
    .scan-item:active { background: #f0f0f0; }
    body.dark-mode .scan-item:active { background: #3a3a3a; }

    .scan-sample { font-weight: 600; color: var(--green1); margin-bottom: 4px; }
    body.dark-mode .scan-sample { color: #7fb3a3; }

    .scan-meta {
      color: #999;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px;
    }
    body.dark-mode .scan-meta { color: #777; }

    .scan-server-id { font-size: 10px; color: #4caf50; margin-top: 4px; }
    .scan-pending { color: #ff9800; font-weight: 600; }

    .list-footer {
      padding: 8px 12px;
      text-align: center;
      color: #999;
      font-size: 12px;
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }
    body.dark-mode .list-footer { border-top-color: var(--border-dark); color: #777; }

    /* SETTINGS */
    .settings-section { padding: 12px 0; border-top: 1px solid var(--border); }
    body.dark-mode .settings-section { border-top-color: var(--border-dark); }

    .connection-status { display: flex; align-items: center; gap: 8px; padding: 8px 0; font-size: 12px; }
    .connection-dot { width: 8px; height: 8px; border-radius: 50%; background: #f44336; }
    .connection-dot.online { background: #4caf50; }

    /* FOOTER STATS */
    .footer-stats {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.25s ease;
      background: #f9f9f9;
      border-top: 1px solid var(--border);
    }
    body.dark-mode .footer-stats { background: var(--card-dark); border-top-color: var(--border-dark); }

    .footer-stats.active { max-height: 220px; }

    .stats-content { padding: 12px; font-size: 12px; color: var(--muted); }
    body.dark-mode .stats-content { color: var(--muted-dark); }

    .stats-row { display: flex; justify-content: space-between; margin-bottom: 6px; padding: 4px 0; gap: 10px; }
    .stats-row strong { color: var(--text); }
    body.dark-mode .stats-row strong { color: var(--text-dark); }

    /* BOTTOM TOOLBAR ‚Äî –ù–ï —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω, –∏–¥—ë—Ç –≤–Ω–∏–∑—É –∫–∞–∫ –æ–±—ã—á–Ω—ã–π –±–ª–æ–∫ */
    .bottom-toolbar {
      display: flex;
      gap: 8px;
      padding: 10px 12px;
      background: var(--card);
      border-top: 1px solid var(--border);
      box-shadow: 0 -2px 8px rgba(0,0,0,0.08);
      flex: 0 0 auto;
    }
    body.dark-mode .bottom-toolbar { background: var(--card-dark); border-top-color: var(--border-dark); }

    .bottom-toolbar button { flex: 1; font-size: 12px; }

    /* MODAL */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 200;
      align-items: center;
      justify-content: center;
      padding: 12px;
    }
    .modal-overlay.active { display: flex; }

    .modal {
      background: var(--card);
      border-radius: 12px;
      padding: 20px;
      max-width: 95vw;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      width: 520px;
    }
    body.dark-mode .modal { background: var(--card-dark); }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    body.dark-mode .modal-header { border-bottom-color: var(--border-dark); }

    .modal-header h2 { font-size: 16px; margin: 0; color: var(--green1); }
    body.dark-mode .modal-header h2 { color: #7fb3a3; }

    .modal-close {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #999;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-transform: none;
      letter-spacing: 0;
    }
    .modal-close:active { color: #333; }

    .diagnostic-log {
      font-family: 'Courier New', monospace;
      font-size: 11px;
      background: #f5f5f5;
      padding: 10px;
      border-radius: 6px;
      max-height: 420px;
      overflow-y: auto;
      margin-bottom: 10px;
      line-height: 1.4;
      color: #333;
      word-break: break-word;
    }
    body.dark-mode .diagnostic-log { background: #1a1a1a; color: #e0e0e0; }

    .log-error { color: #d32f2f; }
    .log-info { color: #0277bd; }
    .log-success { color: #388e3c; }

    @media (max-width: 600px) {
      .main-container { padding: 8px; gap: 8px; }
      .section { padding: 10px; }
      .bottom-toolbar { padding: 8px; }
      .bottom-toolbar button { font-size: 11px; }
      .modal { width: 95vw; }
    }
  </style>
</head>

<body>
  <div id="app">
    <!-- HEADER -->
    <div class="header">
      <h1>‚õè –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–±</h1>
      <div class="sync-status">
        <span class="sync-indicator" id="syncIndicator"></span>
        <span id="syncText">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</span>
      </div>
    </div>

    <!-- THEME TOGGLE -->
    <button class="theme-toggle" id="themeToggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåô</button>

    <!-- Backdrop for mobile drawer -->
    <div class="drawer-backdrop" id="drawerBackdrop"></div>

    <!-- MAIN CONTENT -->
    <div class="main-container">
      <!-- LEFT PANEL -->
      <div class="left-panel">
        <!-- CAMERA SECTION -->
        <div class="section">
          <div class="section-title">–ö–∞–º–µ—Ä–∞</div>
          <div id="videoContainer">
            <video id="video" playsinline autoplay muted></video>
            <div class="camera-overlay"></div>
            <div class="camera-status" id="cameraStatus">üìπ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è‚Ä¶</div>
          </div>
          <button class="btn-secondary" style="width: 100%;" id="restartCameraBtn">üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
        </div>

        <!-- SAMPLE INPUT SECTION -->
        <div class="section">
          <div class="section-title">–í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–±—ã</div>

          <div class="form-group">
            <label for="sampleInput">–û–±—Ä–∞–∑–µ—Ü (—à—Ç—Ä–∏—Ö–∫–æ–¥)</label>
            <input type="text" id="sampleInput" placeholder="–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –ø—Ä–æ–±—ã" inputmode="none" />
          </div>

          <div class="form-group inline">
            <div style="flex: 1; min-width:0;">
              <label for="wellNameInput">–°–∫–≤–∞–∂–∏–Ω–∞</label>
              <input type="number" id="wellNameInput" placeholder="–ù–æ–º–µ—Ä —Å–∫–≤–∞–∂–∏–Ω—ã" inputmode="numeric" />
            </div>
            <div style="flex: 1; min-width:0;">
              <label for="blockInput">–ë–ª–æ–∫</label>
              <input type="text" id="blockInput" placeholder="–ù–æ–º–µ—Ä –±–ª–æ–∫–∞" inputmode="none" />
            </div>
          </div>

          <div class="form-group inline">
            <div style="flex: 1; min-width:0;">
              <label for="typeSelect">–¢–∏–ø —Ä—É–¥—ã</label>
              <select id="typeSelect">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                <option value="520">520</option>
                <option value="360">360</option>
                <option value="520/360">520/360</option>
                <option value="–î—Ä—É–≥–æ–π">–î—Ä—É–≥–æ–π</option>
              </select>
            </div>
          </div>

          <button class="btn-primary" style="width: 100%; margin-bottom: 12px;" id="saveScanBtn">‚úì –ó–∞–ø–∏—Å–∞—Ç—å</button>

          <div class="status-message" id="statusMessage">–û–∂–∏–¥–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è‚Ä¶</div>
        </div>

        <!-- COUNTERS -->
        <div class="counters">
          <div class="counter">
            <div class="counter-label">–°–µ–≥–æ–¥–Ω—è</div>
            <div class="counter-value" id="todayCount">0</div>
          </div>
          <div class="counter">
            <div class="counter-label">–í—Å–µ–≥–æ (–ª–æ–∫–∞–ª—å–Ω–æ)</div>
            <div class="counter-value" id="totalCount">0</div>
          </div>
        </div>

        <!-- EXPORT BUTTON -->
        <button class="btn-secondary" style="width: 100%;" id="exportCsvBtn">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
      </div>

      <!-- RIGHT PANEL -->
      <div class="right-panel" id="rightPanel">
        <div class="list-header">
          <div class="section-title">–ó–∞–ø–∏—Å–∞–Ω–Ω—ã–µ –ø—Ä–æ–±—ã</div>
          <div class="search-box">
            <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ Sample/–°–∫–≤–∞–∂–∏–Ω–µ" />
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="pendingOnlyCheckbox" />
            <label for="pendingOnlyCheckbox">–¢–æ–ª—å–∫–æ –Ω–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</label>
          </div>
        </div>

        <div class="scans-list" id="scansList"></div>

        <div class="list-footer">
          <span id="scansCount">–ó–∞–ø–∏—Å–µ–π: 0</span>
        </div>

        <div class="settings-section" style="padding: 12px;">
          <label for="operatorNameInput">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
          <input type="text" id="operatorNameInput" placeholder="–ò–º—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞" style="margin-top: 6px;" />
          <div class="connection-status" id="connectionStatus" style="margin-top: 12px;">
            <span class="connection-dot online"></span>
            <span>‚úÖ –û–Ω–ª–∞–π–Ω</span>
          </div>
        </div>
      </div>
    </div>

    <!-- FOOTER STATS -->
    <div class="footer-stats" id="footerStats">
      <div class="stats-content">
        <div class="stats-row">
          <span>–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π (–ª–æ–∫–∞–ª—å–Ω–æ):</span>
          <strong id="statsTotal">0</strong>
        </div>
        <div class="stats-row">
          <span>–°–µ–≥–æ–¥–Ω—è:</span>
          <strong id="statsToday">0</strong>
        </div>
        <div class="stats-row">
          <span>–ü–æ—Å–ª–µ–¥–Ω–∏–π –±–ª–æ–∫:</span>
          <strong id="statsLastBlock">-</strong>
        </div>
        <div class="stats-row">
          <span>–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ:</span>
          <strong id="statsServerCount">-</strong>
        </div>
        <div class="stats-row" style="margin-top: 12px; font-size: 11px; opacity: 0.7;">
          <span>–í–µ—Ä—Å–∏—è PWA</span>
          <strong id="versionText">1.0.0 PWA - –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ + SQL —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</strong>
        </div>
        <div class="stats-row" style="font-size: 11px; opacity: 0.7;">
          <span>Build</span>
          <strong id="buildText">-</strong>
        </div>
      </div>
    </div>

    <!-- BOTTOM TOOLBAR (–≤ –ø–æ—Ç–æ–∫–µ, –¥–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π) -->
    <div class="bottom-toolbar">
      <button class="btn-secondary" id="toggleListBtn">üìã –ü—Ä–æ–±—ã</button>
      <button class="btn-secondary" id="toggleStatsBtn">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
      <button class="btn-secondary" id="diagnosticsBtn">‚öô –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</button>
    </div>
  </div>

  <!-- MODAL: DIAGNOSTICS -->
  <div class="modal-overlay" id="diagnosticsModal">
    <div class="modal">
      <div class="modal-header">
        <h2>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h2>
        <button class="modal-close" id="diagnosticsCloseBtn">‚úï</button>
      </div>
      <div id="diagnosticLogContainer" class="diagnostic-log"></div>
      <button class="btn-secondary" style="width: 100%; margin-top: 8px;" id="clearLogBtn">üóë –û—á–∏—Å—Ç–∏—Ç—å –∂—É—Ä–Ω–∞–ª</button>
    </div>
  </div>

  <!-- ZXing -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>

  <script>
    // ========================================
    // CONFIGURATION & CONSTANTS
    // ========================================
    const APP_VERSION = '1.0.0';
    const BUILD_DATE = '2025-12-28T09:50:47Z';
    const BUILD_HASH = '2113b4a995';

    // –í–∞–∂–Ω–æ: –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø–æ Wi-Fi –ø–æ–º–µ–Ω—è–π—Ç–µ localhost –Ω–∞ IP –ü–ö (–Ω–∞–ø—Ä–∏–º–µ—Ä http://192.168.1.100:3000)
    const API_BASE_URL = ''; // –ü—É—Å—Ç–æ = –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏ /api/
    const API_TIMEOUT = 10000;
    const SYNC_INTERVAL = 30000;

    const DB_NAME = 'sampling_scans_db_v2';
    const DB_VERSION = 1;

    // ========================================
    // STATE
    // ========================================
    let db = null;
    let codeReader = null;
    let videoStream = null;
    let isOnline = navigator.onLine;
    let lastScannedBarcode = null;
    let lastServerCount = 0;
    let syncIntervalId = null;
    let darkMode = localStorage.getItem('darkMode') === 'true';

    // ========================================
    // LOGGER
    // ========================================
    const logger = {
      MAX_LOGS: 100,
      log(level, message) {
        const ts = new Date();
        const entry = { ts: ts.getTime(), level, message };
        try { db_module.addLog(entry).catch(() => {}); } catch(e) {}
        console.log(`[${level.toUpperCase()}]`, message);
      },
      info(msg) { this.log('info', msg); },
      error(msg) { this.log('error', msg); },
      success(msg) { this.log('success', msg); }
    };

    // ========================================
    // INDEXED DB MODULE
    // ========================================
    const db_module = {
      instance: null,

      async init() {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open(DB_NAME, DB_VERSION);

          req.onupgradeneeded = (e) => {
            const db = e.target.result;

            if (!db.objectStoreNames.contains('scans')) {
              const scansStore = db.createObjectStore('scans', { keyPath: 'id', autoIncrement: true });
              scansStore.createIndex('sync_status', 'sync_status', { unique: false });
              scansStore.createIndex('scanned_at', 'scanned_at', { unique: false });
              scansStore.createIndex('sample', 'sample', { unique: false });
            }

            if (!db.objectStoreNames.contains('logs')) {
              db.createObjectStore('logs', { keyPath: 'id', autoIncrement: true });
            }
          };

          req.onsuccess = () => {
            this.instance = req.result;
            logger.info('IndexedDB –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
            resolve(this.instance);
          };

          req.onerror = () => {
            logger.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ IndexedDB: ' + req.error);
            reject(req.error);
          };
        });
      },

      async addScan(scan) {
        return new Promise((resolve, reject) => {
          const tx = this.instance.transaction(['scans'], 'readwrite');
          const store = tx.objectStore('scans');
          const req = store.add(scan);
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
      },

      async getAllScans() {
        return new Promise((resolve, reject) => {
          const tx = this.instance.transaction(['scans'], 'readonly');
          const store = tx.objectStore('scans');
          const req = store.getAll();
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
      },

      async getPendingScans() {
        return new Promise((resolve, reject) => {
          const tx = this.instance.transaction(['scans'], 'readonly');
          const store = tx.objectStore('scans');
          const index = store.index('sync_status');
          const req = index.getAll('pending');
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
      },

      async markSynced(pairs) {
        if (!pairs || pairs.length === 0) return;
        return new Promise((resolve, reject) => {
          const tx = this.instance.transaction(['scans'], 'readwrite');
          const store = tx.objectStore('scans');
          let done = 0;
          let failed = false;

          pairs.forEach(({ localId, serverId }) => {
            const req = store.get(localId);
            req.onsuccess = () => {
              const scan = req.result;
              if (!scan) {
                done++;
                if (done === pairs.length && !failed) resolve();
                return;
              }
              scan.sync_status = 'synced';
              scan.server_id = serverId;
              const updateReq = store.put(scan);
              updateReq.onsuccess = () => {
                done++;
                if (done === pairs.length && !failed) resolve();
              };
              updateReq.onerror = (e) => {
                failed = true;
                reject(e.target.error);
              };
            };
            req.onerror = (e) => {
              failed = true;
              reject(e.target.error);
            };
          });
        });
      },

      async addLog(entry) {
        return new Promise((resolve, reject) => {
          const tx = this.instance.transaction(['logs'], 'readwrite');
          const store = tx.objectStore('logs');
          const req = store.add(entry);
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
      },

      async getLogs(limit = 100) {
        return new Promise((resolve, reject) => {
          const tx = this.instance.transaction(['logs'], 'readonly');
          const store = tx.objectStore('logs');
          const req = store.getAll();
          req.onsuccess = () => {
            let logs = req.result || [];
            if (logs.length > limit) logs = logs.slice(logs.length - limit);
            resolve(logs);
          };
          req.onerror = () => reject(req.error);
        });
      },

      async clearLogs() {
        return new Promise((resolve, reject) => {
          const tx = this.instance.transaction(['logs'], 'readwrite');
          const store = tx.objectStore('logs');
          const req = store.clear();
          req.onsuccess = () => resolve();
          req.onerror = () => reject(req.error);
        });
      }
    };

    // ========================================
    // VALIDATION & DB OPERATIONS
    // ========================================
    function saveScanToDb(scan) {
      // STRICT VALIDATION: —Ç–æ–ª—å–∫–æ –æ—Ç—Å—é–¥–∞ –¥–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø–∏—Å—å
      if (!scan.sample || scan.sample.trim() === '') return false;
      if (!scan.block || scan.block.trim() === '') return false;
      if (!scan.well_name || scan.well_name.trim() === '') return false;

      scan.scanned_at = Date.now();
      scan.sync_status = 'pending';
      scan.is_test = !!scan.is_test;

      db_module.addScan(scan)
        .then(id => logger.success(`–ü—Ä–æ–±–∞ –∑–∞–ø–∏—Å–∞–Ω–∞ (ID: ${id}): ${scan.sample}`))
        .catch(err => logger.error(`–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ –ë–î: ${err && err.message ? err.message : err}`));

      return true;
    }

    // ========================================
    // CAMERA CONTROL
    // ========================================
    async function initCamera() {
      try {
        updateCameraStatus('üìπ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è‚Ä¶');
        if (!window.ZXing || !ZXing.BrowserMultiFormatReader) {
          updateCameraStatus('üî¥ ZXing –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è');
          return;
        }
        if (!codeReader) codeReader = new ZXing.BrowserMultiFormatReader();

        // reset previous
        try { await codeReader.reset(); } catch(e) {}

        // decodeFromVideoDevice —Å–∞–º –≤—ã–±–∏—Ä–∞–µ—Ç –¥–µ–≤–∞–π—Å (–æ–±—ã—á–Ω–æ –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É)
        await codeReader.decodeFromVideoDevice(undefined, 'video', (result, err) => {
          if (result) handleBarcodeScanned(result.text);
          // err –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º (ZXing —á–∞—Å—Ç–æ –∫–∏–¥–∞–µ—Ç NotFoundException –ø–æ–∫–∞ –Ω–µ —É–≤–∏–¥–∏—Ç –∫–æ–¥)
        });

        updateCameraStatus('üü¢ –°–∫–∞–Ω–∏—Ä—É–µ—Ç', 'scanning');
        logger.info('–ö–∞–º–µ—Ä–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
      } catch (err) {
        logger.error(`–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: ${err && err.message ? err.message : err}`);
        updateCameraStatus('üî¥ –û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã');
      }
    }

    function updateCameraStatus(text, className = '') {
      const el = document.getElementById('cameraStatus');
      el.textContent = text;
      el.className = 'camera-status' + (className ? (' ' + className) : '');
    }

    async function stopCamera() {
      try {
        if (codeReader) await codeReader.reset();
        if (videoStream) {
          videoStream.getTracks().forEach(track => track.stop());
          videoStream = null;
        }
        updateCameraStatus('‚≠ï –û—Ç–∫–ª—é—á–µ–Ω–∞');
      } catch (err) {
        logger.error(`–û—à–∏–±–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã: ${err && err.message ? err.message : err}`);
      }
    }

    function handleBarcodeScanned(text) {
      lastScannedBarcode = String(text || '').trim();
      const sampleInput = document.getElementById('sampleInput');
      sampleInput.value = lastScannedBarcode;
      showStatus(`–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ: ${lastScannedBarcode}`, 'success');

      // –í —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç –ù–ï –ø–∏—à–µ–º –≤ IndexedDB ‚Äî —Ç–æ–ª—å–∫–æ –∑–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ.
      playBeep();
      vibrate(120);

      // –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–µ –ª–æ–≤–∏–ª–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ
      stopCamera();
      sampleInput.focus();
      logger.success(`–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ: ${lastScannedBarcode}`);
    }

    // ========================================
    // USER ACTIONS
    // ========================================
    function processScan() {
      const sampleEl = document.getElementById('sampleInput');
      const blockEl = document.getElementById('blockInput');
      const wellEl = document.getElementById('wellNameInput');
      const typeEl = document.getElementById('typeSelect');
      const operatorEl = document.getElementById('operatorNameInput');

      const sample = (sampleEl.value || '').trim();
      const block = (blockEl.value || '').trim();
      const wellName = (wellEl.value || '').trim();
      const type = (typeEl.value || '').trim();
      const operatorName = (operatorEl.value || '').trim();

      if (!sample) {
        showStatus('–í–≤–µ–¥–∏—Ç–µ Sample –∏–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ', 'error');
        sampleEl.focus();
        return;
      }
      if (!block) {
        showStatus('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ "–ë–ª–æ–∫"', 'error');
        blockEl.focus();
        return;
      }
      if (!wellName) {
        showStatus('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ "–°–∫–≤–∞–∂–∏–Ω–∞"', 'error');
        wellEl.focus();
        return;
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–ª–æ–∫ –∫–∞–∫ "–ø–æ—Å–ª–µ–¥–Ω–∏–π"
      localStorage.setItem('lastBlock', block);

      const scan = {
        sample,
        well_name: wellName,
        block,
        type: type || '–ù–µ —É–∫–∞–∑–∞–Ω',
        scanned_by: operatorName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä',
        sync_status: 'pending',
        is_test: false
      };

      const ok = saveScanToDb(scan);
      if (!ok) {
        showStatus('–ó–∞–ø–∏—Å—å –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
        return;
      }

      showStatus(`‚úì –ó–∞–ø–∏—Å–∞–Ω–æ: ${sample} | –°–∫–≤: ${wellName} | –ë–ª–æ–∫: ${block} | –¢–∏–ø: ${scan.type}`, 'success');

      // beep + –≤–∏–±—Ä–∞—Ü–∏—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–ø–∏—Å–∏
      playBeep();
      vibrate(120);

      // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π: Sample –∏ –°–∫–≤–∞–∂–∏–Ω–∞ (–ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É)
      sampleEl.value = '';
      wellEl.value = ''; // <-- –í–ê–ñ–ù–û: –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ "–°–∫–≤–∞–∂–∏–Ω–∞"
      lastScannedBarcode = null;

      refreshScans();
      updateStats();

      if (isOnline) syncPendingScans();

      sampleEl.focus();
      initCamera();
    }

    function showStatus(message, type = 'default') {
      const el = document.getElementById('statusMessage');
      el.textContent = message;
      el.className = 'status-message';
      if (type && type !== 'default') el.classList.add(type);
    }

    function playBeep() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.value = 800;
        oscillator.type = 'sine';

        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.1);
      } catch (e) {}
    }

    function vibrate(duration = 100) {
      if (navigator.vibrate) navigator.vibrate(duration);
    }

    // ========================================
    // DATA SYNC
    // ========================================
    async function syncPendingScans() {
      try {
        const pending = await db_module.getPendingScans();
        if (!pending || pending.length === 0) {
          updateSyncIndicator();
          return;
        }

        const deviceId = getOrCreateDeviceId();
        const payload = pending.map(scan => ({
          device_id: deviceId,
          sample: scan.sample,
          well_name: scan.well_name,
          block: scan.block,
          type: scan.type,
          scanned_at: scan.scanned_at,
          scanned_by: scan.scanned_by,
          is_test: !!scan.is_test,
          local_id: scan.id
        }));

        const response = await fetch(`${API_BASE_URL}/api/scans/bulk`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-API-Key': 'test-key'
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        const serverIds = Array.isArray(result.server_ids) ? result.server_ids : [];
        const pairs = pending.map((scan, idx) => ({
          localId: scan.id,
          serverId: serverIds[idx] ?? null
        })).filter(p => p.serverId !== null);

        await db_module.markSynced(pairs);

        if (typeof result.total_on_server === 'number') lastServerCount = result.total_on_server;
        logger.success(`–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ${pairs.length} / ${pending.length} –∑–∞–ø–∏—Å–µ–π`);

        refreshScans();
        updateSyncIndicator();
        updateStats();
      } catch (err) {
        logger.error(`–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ${err && err.message ? err.message : err}`);
        updateSyncIndicator();
      }
    }

    function getOrCreateDeviceId() {
      let deviceId = localStorage.getItem('deviceId');
      if (!deviceId) {
        deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).slice(2, 10);
        localStorage.setItem('deviceId', deviceId);
      }
      return deviceId;
    }

    // ========================================
    // UI REFRESH
    // ========================================
    async function refreshScans() {
      const scans = await db_module.getAllScans();
      const searchQuery = (document.getElementById('searchInput').value || '').toLowerCase();
      const pendingOnly = document.getElementById('pendingOnlyCheckbox').checked;

      let filtered = scans || [];
      if (pendingOnly) filtered = filtered.filter(s => s.sync_status === 'pending');

      if (searchQuery) {
        filtered = filtered.filter(s =>
          String(s.sample || '').toLowerCase().includes(searchQuery) ||
          String(s.well_name || '').toLowerCase().includes(searchQuery)
        );
      }

      const listContainer = document.getElementById('scansList');
      listContainer.innerHTML = '';

      filtered
        .sort((a,b) => (b.scanned_at || 0) - (a.scanned_at || 0))
        .forEach(scan => {
          const item = document.createElement('div');
          item.className = 'scan-item';

          const status = scan.sync_status === 'pending'
            ? '<span class="scan-pending">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ</span>'
            : '';

          const serverId = scan.server_id
            ? `<div class="scan-server-id">‚úì –°–µ—Ä–≤–µ—Ä: ${scan.server_id}</div>`
            : '';

          const date = new Date(scan.scanned_at || Date.now()).toLocaleString('ru-RU');

          item.innerHTML = `
            <div class="scan-sample">${escapeHtml(scan.sample || '')} ${status}</div>
            <div class="scan-meta">
              <span>–°–∫–≤: ${escapeHtml(scan.well_name || '')}</span>
              <span>–¢–∏–ø: ${escapeHtml(scan.type || '')}</span>
            </div>
            <div class="scan-meta">
              <span>–ë–ª–æ–∫: ${escapeHtml(scan.block || '')}</span>
              <span>${escapeHtml(date)}</span>
            </div>
            ${serverId}
          `;
          listContainer.appendChild(item);
        });

      document.getElementById('scansCount').textContent = `–ó–∞–ø–∏—Å–µ–π: ${filtered.length}`;
      updateSyncIndicator();
    }

    async function updateStats() {
      const scans = await db_module.getAllScans();
      const list = (scans || []).filter(s => !s.is_test);

      const today = new Date();
      today.setHours(0,0,0,0);
      const todayMs = today.getTime();

      const todayScans = list.filter(s => (s.scanned_at || 0) >= todayMs);
      const lastBlock = list.length > 0 ? list[list.length - 1].block : (localStorage.getItem('lastBlock') || '-');

      document.getElementById('todayCount').textContent = todayScans.length;
      document.getElementById('totalCount').textContent = list.length;

      document.getElementById('statsTotal').textContent = list.length;
      document.getElementById('statsToday').textContent = todayScans.length;
      document.getElementById('statsLastBlock').textContent = lastBlock || '-';
      document.getElementById('statsServerCount').textContent = (lastServerCount || '-') + '';
      document.getElementById('buildText').textContent = `${BUILD_HASH} / ${BUILD_DATE}`;
      document.getElementById('versionText').textContent = `${APP_VERSION} PWA - –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ + SQL —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è`;
    }

    async function updateSyncIndicator() {
      const pending = await db_module.getPendingScans();
      const allScans = await db_module.getAllScans();

      const pendingCount = (pending || []).length;
      const totalCount = (allScans || []).length;

      const indicator = document.getElementById('syncIndicator');
      const text = document.getElementById('syncText');

      if (pendingCount > 0) {
        indicator.className = 'sync-indicator';
        text.textContent = `‚áÖ –ª–æ–∫–∞–ª—å–Ω–æ ${totalCount}, –≤ –æ–∂–∏–¥–∞–Ω–∏–∏ ${pendingCount} / —Å–µ—Ä–≤–µ—Ä ${lastServerCount || '?'}`;
      } else {
        indicator.className = 'sync-indicator ok';
        text.textContent = `‚áÖ –ª–æ–∫–∞–ª—å–Ω–æ ${totalCount}, –≤ –æ–∂–∏–¥–∞–Ω–∏–∏ 0 / —Å–µ—Ä–≤–µ—Ä ${lastServerCount || '?'}`;
      }
    }

    // ========================================
    // EXPORT CSV
    // ========================================
    async function exportCsv() {
      try {
        const scans = await db_module.getAllScans();
        const list = (scans || []);

        if (list.length === 0) {
          logger.error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
          showStatus('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'error');
          return;
        }

        const headers = ['Sample','–°–∫–≤–∞–∂–∏–Ω–∞','–¢–∏–ø','–ë–ª–æ–∫','–î–∞—Ç–∞','–°–æ—Ç—Ä—É–¥–Ω–∏–∫','SyncStatus','ServerID','IsTest'];
        const rows = list.map(s => [
          s.sample || '',
          s.well_name || '',
          s.type || '',
          s.block || '',
          new Date(s.scanned_at || Date.now()).toLocaleString('ru-RU'),
          s.scanned_by || '',
          s.sync_status || '',
          s.server_id || '',
          s.is_test ? 'true' : 'false'
        ]);

        let csv = headers.map(h => `"${String(h).replace(/"/g,'""')}"`).join(',') + '\n';
        rows.forEach(row => {
          csv += row.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',') + '\n';
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `sampling_${Date.now()}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        logger.success(`–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${list.length} –∑–∞–ø–∏—Å–µ–π`);
        showStatus(`CSV —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω: ${list.length} –∑–∞–ø–∏—Å–µ–π`, 'success');

        // –ø–æ—Å–ª–µ —ç–∫—Å–ø–æ—Ä—Ç–∞ ‚Äî –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã
        initCamera();
      } catch (err) {
        logger.error(`–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${err && err.message ? err.message : err}`);
        showStatus('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ CSV', 'error');
      }
    }

    // ========================================
    // DIAGNOSTICS
    // ========================================
    async function openDiagnostics() {
      const logs = await db_module.getLogs(100);
      const logContainer = document.getElementById('diagnosticLogContainer');

      if (!logs || logs.length === 0) {
        logContainer.innerHTML = '<div style="opacity: 0.5;">–ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç</div>';
        return;
      }

      let html = '';
      logs.forEach(log => {
        const date = new Date(log.ts).toLocaleString('ru-RU');
        const level = String(log.level || 'info').toLowerCase();
        const className = `log-${level}`;
        html += `<div class="${className}">${escapeHtml(date)} [${escapeHtml(level.toUpperCase())}]: ${escapeHtml(log.message || '')}</div>`;
      });

      logContainer.innerHTML = html;
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    // ========================================
    // THEME
    // ========================================
    function toggleTheme() {
      darkMode = !darkMode;
      localStorage.setItem('darkMode', darkMode ? 'true' : 'false');
      applyTheme();
    }

    function applyTheme() {
      if (darkMode) {
        document.body.classList.add('dark-mode');
        document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
      } else {
        document.body.classList.remove('dark-mode');
        document.getElementById('themeToggle').textContent = 'üåô';
      }
    }

    // ========================================
    // NETWORK STATUS
    // ========================================
    window.addEventListener('online', () => {
      isOnline = true;
      updateConnectionStatus();
      syncPendingScans();
      logger.info('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
    });

    window.addEventListener('offline', () => {
      isOnline = false;
      updateConnectionStatus();
      logger.info('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ');
    });

    function updateConnectionStatus() {
      const statusEl = document.getElementById('connectionStatus');
      if (!statusEl) return;

      if (isOnline) {
        statusEl.innerHTML = '<span class="connection-dot online"></span><span>‚úÖ –û–Ω–ª–∞–π–Ω (–¥–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è)</span>';
      } else {
        statusEl.innerHTML = '<span class="connection-dot"></span><span>üî¥ –û—Ñ–ª–∞–π–Ω (–∑–∞–ø–∏—Å–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ)</span>';
      }
    }

    // ========================================
    // PERSISTENT DATA
    // ========================================
    function loadPersistentData() {
      const lastBlock = localStorage.getItem('lastBlock');
      if (lastBlock) document.getElementById('blockInput').value = lastBlock;

      const operatorName = localStorage.getItem('operatorName');
      if (operatorName) document.getElementById('operatorNameInput').value = operatorName;
    }

    // ========================================
    // HELPERS
    // ========================================
    function escapeHtml(str) {
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function toggleListPanel() {
      const panel = document.getElementById('rightPanel');
      const backdrop = document.getElementById('drawerBackdrop');
      const isActive = panel.classList.toggle('active');

      // backdrop —Ç–æ–ª—å–∫–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º (–Ω–æ –º–æ–∂–Ω–æ –∏ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ ‚Äî –Ω–µ –º–µ—à–∞–µ—Ç)
      if (window.matchMedia('(max-width: 768px)').matches) {
        backdrop.classList.toggle('active', isActive);
      } else {
        backdrop.classList.remove('active');
      }
    }

    function closeListPanel() {
      const panel = document.getElementById('rightPanel');
      const backdrop = document.getElementById('drawerBackdrop');
      panel.classList.remove('active');
      backdrop.classList.remove('active');
    }

    // ========================================
    // EVENT LISTENERS
    // ========================================
    document.getElementById('saveScanBtn').addEventListener('click', processScan);
    document.getElementById('sampleInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') processScan();
    });

    document.getElementById('restartCameraBtn').addEventListener('click', async () => {
      logger.info('–†—É—á–Ω–æ–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã');
      await stopCamera();
      await initCamera();
    });

    document.getElementById('exportCsvBtn').addEventListener('click', exportCsv);

    document.getElementById('toggleListBtn').addEventListener('click', () => {
      toggleListPanel();
      refreshScans();
    });

    document.getElementById('drawerBackdrop').addEventListener('click', closeListPanel);

    document.getElementById('toggleStatsBtn').addEventListener('click', () => {
      document.getElementById('footerStats').classList.toggle('active');
    });

    document.getElementById('diagnosticsBtn').addEventListener('click', () => {
      document.getElementById('diagnosticsModal').classList.add('active');
      openDiagnostics();
    });

    document.getElementById('diagnosticsCloseBtn').addEventListener('click', () => {
      document.getElementById('diagnosticsModal').classList.remove('active');
    });

    document.getElementById('diagnosticsModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('diagnosticsModal')) {
        document.getElementById('diagnosticsModal').classList.remove('active');
      }
    });

    document.getElementById('clearLogBtn').addEventListener('click', async () => {
      await db_module.clearLogs();
      logger.info('–ñ—É—Ä–Ω–∞–ª –æ—á–∏—â–µ–Ω');
      openDiagnostics();
    });

    document.getElementById('themeToggle').addEventListener('click', toggleTheme);

    document.getElementById('searchInput').addEventListener('input', refreshScans);
    document.getElementById('pendingOnlyCheckbox').addEventListener('change', refreshScans);

    document.getElementById('operatorNameInput').addEventListener('change', (e) => {
      localStorage.setItem('operatorName', e.target.value || '');
    });

    // ========================================
    // INITIALIZATION
    // ========================================
    async function init() {
      try {
        applyTheme();

        db = await db_module.init();
        loadPersistentData();

        updateConnectionStatus();
        await refreshScans();
        await updateStats();
        await updateSyncIndicator();

        // –ö–∞–º–µ—Ä–∞
        await initCamera();

        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
        syncIntervalId = setInterval(() => {
          if (isOnline) syncPendingScans();
        }, SYNC_INTERVAL);

        logger.success('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');

        // Register service worker
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('service-worker.js')
            .then(() => logger.info('Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω'))
            .catch(err => logger.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Service Worker: ' + err.message));
        }
      } catch (err) {
        logger.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + (err && err.message ? err.message : err));
        alert('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: ' + (err && err.message ? err.message : err));
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
